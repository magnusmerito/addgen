name: Generate and Deploy Random Addresses

on:
  push:
    branches:
      - main   # Rebuild when pushing changes to the main branch
    tags:
      - 'v*'   # Rebuild when pushing a new tag starting with 'v'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Generate HTML page
        run: |
          chmod +x generate.sh
          ./generate.sh

      - name: Deploy to GitHub Pages using native Git commands
        run: |
          # Configure Git for commits
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch all remote branches, including gh-pages
          git fetch origin gh-pages || echo "gh-pages branch does not exist yet."

          # If gh-pages branch exists, switch to it; otherwise, create it
          if git ls-remote --exit-code --heads origin gh-pages; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
          fi

          # Remove old files (only index.html, preserving workflows)
          rm -f index.html

          # Move the newly generated index.html
          cp index.html .

          # Add, commit, and push the changes
          git add index.html
          git commit -m "Deploy updated random addresses"
          git push --force origin gh-pages
